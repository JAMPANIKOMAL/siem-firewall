<!DOCTYPE html>
<html>
<head>
    <title>Python Firewall Dashboard</title>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #0d1117;
            color: #f0f6fc;
            padding: 0;
            margin: 0;
            transition: background 0.3s, color 0.3s;
        }
        body.light-mode {
            background-color: #f6f8fa;
            color: #161b22;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 30px 20px;
            background: #161b22;
            border-radius: 16px;
            box-shadow: 0 4px 32px rgba(20, 20, 30, 0.25);
            transition: background 0.3s;
        }
        body.light-mode .container {
            background: #fff;
            box-shadow: 0 4px 32px rgba(20, 20, 30, 0.10);
        }
        h1 {
            color: #58a6ff;
            margin-bottom: 32px;
            font-size: 2.2rem;
            text-align: center;
            letter-spacing: 1px;
        }
        body.light-mode h1 {
            color: #0366d6;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .toggle-btn {
            background: #21262c;
            color: #f0f6fc;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 15px;
            transition: background 0.2s;
        }
        .toggle-btn:hover {
            background: #30363d;
        }
        body.light-mode .toggle-btn {
            background: #eaecef;
            color: #161b22;
        }
        .dashboard-export-btn {
            background: #0366d6;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 15px;
            margin-left: 10px;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .dashboard-export-btn:hover {
            background: #2188ff;
        }
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 24px;
            margin-bottom: 36px;
        }
        .chart-box {
            flex: 1 1 220px;
            max-width: 240px;
            min-width: 200px;
            height: 240px;
            background-color: #161b22;
            padding: 16px;
            border-radius: 14px;
            box-shadow: 0 0 10px rgba(255,255,255,0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            transition: background 0.3s;
        }
        body.light-mode .chart-box {
            background-color: #f6f8fa;
            box-shadow: 0 0 10px rgba(20,20,30,0.04);
        }
        .chart-title {
            color: #58a6ff;
            font-size: 1.1rem;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 500;
        }
        body.light-mode .chart-title {
            color: #0366d6;
        }
        .chart-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 4px;
        }
        .chart-download-btn {
            background: #238636;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            margin-left: 0;
            margin-right: 0;
            transition: background 0.2s;
        }
        .chart-download-btn:hover {
            background: #2ea043;
        }
        body.light-mode .chart-download-btn {
            background: #0366d6;
            color: #fff;
        }
        table.dataTable {
            width: 100% !important;
            border-radius: 10px;
            overflow: hidden;
            background: #161b22;
        }
        body.light-mode table.dataTable {
            background: #fff;
        }
        table.dataTable thead th {
            background-color: #21262c;
            color: #ffffff;
            font-size: 15px;
            border-bottom: 2px solid #30363d;
        }
        body.light-mode table.dataTable thead th {
            background-color: #eaecef;
            color: #161b22;
            border-bottom: 2px solid #d1d5da;
        }
        table.dataTable tbody td {
            color: #c9d1d9;
            font-size: 14px;
        }
        body.light-mode table.dataTable tbody td {
            color: #161b22;
        }
        .dataTables_filter {
            display: none !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #f0f6fc !important;
            background: #161b22 !important;
            border: 1px solid #30363d !important;
            border-radius: 6px !important;
            margin: 0 2px;
        }
        body.light-mode .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #161b22 !important;
            background: #eaecef !important;
            border: 1px solid #d1d5da !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #238636 !important;
            color: #fff !important;
        }
        body.light-mode .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #0366d6 !important;
            color: #fff !important;
        }
        .dataTables_wrapper .dataTables_info {
            color: #f0f6fc !important;
        }
        body.light-mode .dataTables_wrapper .dataTables_info {
            color: #161b22 !important;
        }
        @media (max-width: 900px) {
            .charts-container {
                flex-direction: column;
                align-items: center;
            }
            .chart-box {
                max-width: 100%;
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container" id="dashboard">
    <div class="top-bar">
        <h1>üî• Python Firewall Log Dashboard</h1>
        <div>
            <button class="toggle-btn" id="toggleModeBtn">üåô Toggle Dark/Light</button>
            <button class="dashboard-export-btn" onclick="exportDashboard('png')" title="Download PNG">
                <span style="font-size:18px;">üñºÔ∏è</span> PNG
            </button>
            <button class="dashboard-export-btn" onclick="exportDashboard('pdf')" title="Download PDF">
                <span style="font-size:18px;">üìÑ</span> PDF
            </button>
        </div>
    </div>

    <form method="get" class="filter-form">
        <input type="text" name="query" placeholder="Search IP or Protocol" value="{{ query }}" class="filter-input">
        <select name="action" class="filter-select">
            <option value="">All</option>
            <option value="ALLOWED" {% if filter_action == 'ALLOWED' %}selected{% endif %}>ALLOWED</option>
            <option value="BLOCKED" {% if filter_action == 'BLOCKED' %}selected{% endif %}>BLOCKED</option>
        </select>
        <button type="submit" class="filter-btn">üîç Search</button>
    </form>

    <div class="charts-container">
        <div class="chart-box">
            <div class="chart-title">Protocol Distribution</div>
            <div class="chart-actions">
                <button class="chart-download-btn" onclick="exportChart('protocolChart', 'png')" title="Download PNG">
                    üñºÔ∏è
                </button>
                <button class="chart-download-btn" onclick="exportChart('protocolChart', 'pdf')" title="Download PDF">
                    üìÑ
                </button>
            </div>
            <canvas id="protocolChart" width="180" height="180"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-title">Action Summary</div>
            <div class="chart-actions">
                <button class="chart-download-btn" onclick="exportChart('actionChart', 'png')" title="Download PNG">
                    üñºÔ∏è
                </button>
                <button class="chart-download-btn" onclick="exportChart('actionChart', 'pdf')" title="Download PDF">
                    üìÑ
                </button>
            </div>
            <canvas id="actionChart" width="180" height="180"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-title">Top Source IPs</div>
            <div class="chart-actions">
                <button class="chart-download-btn" onclick="exportChart('ipChart', 'png')" title="Download PNG">
                    üñºÔ∏è
                </button>
                <button class="chart-download-btn" onclick="exportChart('ipChart', 'pdf')" title="Download PDF">
                    üìÑ
                </button>
            </div>
            <canvas id="ipChart" width="180" height="180"></canvas>
        </div>
    </div>

    <table id="logTable" class="display">
        <thead>
            <tr>
                <th>ID</th>
                <th>Time</th>
                <th>Source IP</th>
                <th>Destination IP</th>
                <th>Protocol</th>
                <th>Action</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log[0] }}</td>
                <td>{{ log[1] }}</td>
                <td>{{ log[2] }}</td>
                <td>{{ log[3] }}</td>
                <td>{{ log[4] }}</td>
                <td>{{ log[5] }}</td>
                <td>{{ log[6] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // DataTable
    $(document).ready(function () {
        $('#logTable').DataTable({
            pageLength: 25,
            order: [[0, "desc"]],
            language: {
                search: "",
                searchPlaceholder: "Search logs..."
            },
            createdRow: function(row, data, dataIndex) {
                $(row).css('background-color', $('body').hasClass('light-mode') ? '#fff' : '#161b22');
            }
        });
    });

    // Chart.js Data
    const protocolData = {
        labels: {{ protocols | map(attribute=0) | list | tojson | safe }},
        datasets: [{
            data: {{ protocols | map(attribute=1) | list | tojson | safe }},
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#8e44ad', '#2ea043', '#d73a49']
        }]
    };
    const actionData = {
        labels: {{ actions | map(attribute=0) | list | tojson | safe }},
        datasets: [{
            data: {{ actions | map(attribute=1) | list | tojson | safe }},
            backgroundColor: ['#2ea043', '#d73a49']
        }]
    };
    const ipData = {
        labels: {{ top_ips | map(attribute=0) | list | tojson | safe }},
        datasets: [{
            label: 'Packets',
            data: {{ top_ips | map(attribute=1) | list | tojson | safe }},
            backgroundColor: '#58a6ff'
        }]
    };

    // Chart.js Options with animation and clickable legend
    function getChartOptions(title, legendDisplay=true) {
        const isLight = document.body.classList.contains('light-mode');
        return {
            responsive: false,
            plugins: {
                legend: {
                    display: legendDisplay,
                    labels: {
                        color: isLight ? '#161b22' : '#f0f6fc',
                        font: { size: 13 },
                        usePointStyle: true,
                        onClick: function(e, legendItem, legend) {
                            const index = legendItem.index;
                            const ci = legend.chart;
                            const meta = ci.getDatasetMeta(0);
                            meta.data[index].hidden = !meta.data[index].hidden;
                            ci.update();
                        }
                    }
                },
                title: {
                    display: false,
                    text: title
                }
            },
            animation: {
                duration: 1200,
                easing: 'easeOutBounce'
            },
            scales: title === 'Top Source IPs' ? {
                y: {
                    beginAtZero: true,
                    ticks: { color: isLight ? '#161b22' : '#f0f6fc', font: { size: 13 } },
                    grid: { color: isLight ? '#d1d5da' : '#30363d' }
                },
                x: {
                    ticks: { color: isLight ? '#161b22' : '#f0f6fc', font: { size: 13 } },
                    grid: { color: isLight ? '#d1d5da' : '#30363d' }
                }
            } : undefined
        };
    }

    // Chart instances
    let protocolChart, actionChart, ipChart;
    function renderCharts() {
        if (protocolChart) protocolChart.destroy();
        if (actionChart) actionChart.destroy();
        if (ipChart) ipChart.destroy();
        protocolChart = new Chart(document.getElementById('protocolChart').getContext('2d'), {
            type: 'pie',
            data: protocolData,
            options: getChartOptions('Protocol Distribution')
        });
        actionChart = new Chart(document.getElementById('actionChart').getContext('2d'), {
            type: 'doughnut',
            data: actionData,
            options: getChartOptions('Action Summary')
        });
        ipChart = new Chart(document.getElementById('ipChart').getContext('2d'), {
            type: 'bar',
            data: ipData,
            options: getChartOptions('Top Source IPs', false)
        });
    }
    renderCharts();

    // Export chart as PNG/PDF
    function exportChart(chartId, type) {
        const canvas = document.getElementById(chartId);
        if (type === 'png') {
            const link = document.createElement('a');
            link.download = chartId + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        } else if (type === 'pdf') {
            html2canvas(canvas).then(function(canvasImg) {
                const imgData = canvasImg.toDataURL('image/png');
                const pdf = new jspdf.jsPDF();
                pdf.addImage(imgData, 'PNG', 10, 10, 180, 120);
                pdf.save(chartId + '.pdf');
            });
        }
    }

    // Export dashboard as PNG/PDF
    function exportDashboard(type) {
        const dashboard = document.getElementById('dashboard');
        html2canvas(dashboard).then(function(canvas) {
            if (type === 'png') {
                const link = document.createElement('a');
                link.download = 'dashboard.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else if (type === 'pdf') {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save('dashboard.pdf');
            }
        });
    }

    // Dark mode toggle
    document.getElementById('toggleModeBtn').onclick = function() {
        document.body.classList.toggle('light-mode');
        setTimeout(renderCharts, 100); // re-render charts for correct legend color
    };
</script>

</body>
</html>