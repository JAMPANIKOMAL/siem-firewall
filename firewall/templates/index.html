<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Live Firewall Dashboard</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        @keyframes new-row-fade {
            from { background-color: rgba(88, 166, 255, 0.4); }
            to { background-color: transparent; }
        }
        .new-row-animation { animation: new-row-fade 2s ease-out; }
    </style>
</head>
<body class="dark-mode">
<div class="container">
    <div class="top-bar">
        <h1 id="dashboardTitle">üî¥ Live Firewall Dashboard</h1>
        <div class="controls-container">
            <div class="toggle-switch">
                <span>Light</span>
                <label class="switch">
                    <input type="checkbox" id="themeToggle">
                    <span class="slider"></span>
                </label>
                <span>Dark</span>
            </div>
            <div class="controls">
                <button id="startBtn">‚ñ∂Ô∏è Start Logging</button>
                <button id="stopBtn" disabled>‚èπÔ∏è Stop Logging</button>
                <button id="clearBtn" class="btn-clear">üóëÔ∏è Clear Logs</button>
                <a href="/save-logs" class="btn-save">üíæ Save Logs</a>
            </div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box"><canvas id="protocolChart"></canvas></div>
        <div class="chart-box"><canvas id="actionChart"></canvas></div>
        <div class="chart-box"><canvas id="ipChart"></canvas></div>
    </div>

    <table id="logTable" class="display">
        <thead>
        <tr>
            <th>ID</th>
            <th>Time</th>
            <th>Source IP</th>
            <th>Destination IP</th>
            <th>Protocol</th>
            <th>Action</th>
            <th>Reason</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
    $(document).ready(function () {
        let charts = {};
        const socket = io();
        const table = $('#logTable').DataTable({ "order": [[0, "desc"]], "pageLength": 10 });

        const initializeCharts = () => {
            const placeholderOptions = (title) => ({ responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: title, font: { size: 16 } }, legend: { display: true }, tooltip: { enabled: false } }, animation: { duration: 0 } });
            const placeholderData = { labels: ['Awaiting Data'], datasets: [{ data: [1], backgroundColor: ['#30363d'], label: 'Awaiting Data' }] };
            if(charts.protocol) charts.protocol.destroy();
            if(charts.action) charts.action.destroy();
            if(charts.ip) charts.ip.destroy();
            charts.protocol = new Chart($('#protocolChart'), { type: 'doughnut', data: { ...placeholderData }, options: placeholderOptions('Protocol Distribution') });
            charts.action = new Chart($('#actionChart'), { type: 'pie', data: { ...placeholderData }, options: placeholderOptions('Action Summary') });
            charts.ip = new Chart($('#ipChart'), { type: 'bar', data: { labels: ['Awaiting Data'], datasets:[{label: 'Packets', data:[0]}]}, options: placeholderOptions('Top Source IPs') });
            updateChartColors();
        };

        socket.on('connect', () => console.log('WebSocket Connected.'));

        socket.on('new_log', (log) => {
            const rowNode = table.row.add([
                log.id, log.timestamp, log.src_ip, log.dst_ip, log.protocol,
                `<span class="action-${log.action.toLowerCase()}">${log.action}</span>`,
                log.reason
            ]).draw(false).node();
            $(rowNode).addClass('new-row-animation');
        });

        socket.on('stats_update', (stats) => updateAllCharts(stats));

        socket.on('logs_cleared', () => {
            console.log('Server confirmed logs cleared. Updating UI.');
            table.clear().draw();
            initializeCharts();
            $('#startBtn').prop('disabled', false);
            $('#stopBtn').prop('disabled', true);
            $('#dashboardTitle').html('üî¥ Live Firewall Dashboard');
        });

        $('#startBtn').on('click', () => {
            socket.emit('start_logging');
            $('#startBtn, #stopBtn').prop('disabled', (i, v) => !v);
            $('#dashboardTitle').html('üü¢ Live Firewall Dashboard');
        });

        $('#stopBtn').on('click', () => {
            socket.emit('stop_logging');
            $('#startBtn, #stopBtn').prop('disabled', (i, v) => !v);
            $('#dashboardTitle').html('üî¥ Live Firewall Dashboard');
        });
        
        $('#clearBtn').on('click', () => {
            if (confirm('Are you sure you want to delete all logs for this session? This action cannot be undone.')) {
                socket.emit('clear_logs');
            }
        });

        $('#themeToggle').on('change', () => {
            $('body').toggleClass('dark-mode light-mode');
            localStorage.setItem('theme', $('body').hasClass('dark-mode') ? 'dark' : 'light');
            updateChartColors();
        });

        const updateAllCharts = (stats) => {
            updateChartData(charts.protocol, stats.protocols);
            updateChartData(charts.action, stats.actions);
            updateChartData(charts.ip, stats.top_ips);
        };

        const updateChartData = (chart, data) => {
            chart.options.animation.duration = 500;
            chart.options.plugins.tooltip.enabled = true;
            chart.data.labels = data.map(d => d[0] || 'Unknown');
            chart.data.datasets[0].data = data.map(d => d[1]);
            chart.data.datasets[0].backgroundColor = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'];
            chart.update();
        };
        
        const updateChartColors = () => {
            const textColor = $('body').hasClass('dark-mode') ? '#e6edf3' : '#24292f';
            Object.values(charts).forEach(chart => {
                if (!chart) return;
                chart.options.plugins.title.color = textColor;
                chart.options.plugins.legend.labels.color = textColor;
                if (chart.options.scales) {
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.y.ticks.color = textColor;
                }
                chart.update();
            });
        };
        
        if (localStorage.getItem('theme') === 'light') {
            $('#themeToggle').prop('checked', false).trigger('change');
        }
        
        initializeCharts();
    });
</script>
</body>
</html>